#!/usr/bin/env node

'use strict';
const fs = require('fs');
const path = require('path');
const program = require('commander');
const defaultsDeep = require('lodash.defaultsdeep');
const gulp = require('gulp');

const gitWebpack = require('../');
const CONFIG_PATH_NAME = 'git-webpack.json';
let CONTEXT = process.cwd();

program
    .version(require('../package.json').version)
    .usage('[options]')
    .option('--modules <dir>...', '模块目录名列表', list)
    .option('--assets [file]', '文件索引表输出路径')
    .option('--no-assets', '不输出文件索引表')
    .option('--dependencies [dir]...', '依赖的文件与目录列表（它的变更会引起模块重新编译）', list)
    .option('--parallel [number]', 'Webpack 进程最大并发数', parseInt)
    .option('--build-timeout [number]', '设置单个 Webpack 构建运行超时限制', parseInt)
    .option('--build-force', '强制编译所有的模块目录')
    .option('--build-timeout [number]', '超时设置', parseInt)
    .option('--build-cwd [dir]', '设置工作目录')
    .option('--build-env [query]', '设置环境变量，例如 GIT_WEBPACK=1&DEPLOY=1', map)
    .option('--build-argv [list]', '设置启动执行 webpack.config.js 的命令行参数', list)
    .option('--build-launch [file]', '设置 webpack 启动文件地址')
    .option('--config [path]', '外部配置文件路径')
    .option('--init', '初始化项目，生成配置文件')
    .parse(process.argv);



function list(val) {
    return val.split(',');
}


function map(val) {
    let ret = {};
    let reg = /([^?&=]+)=([^?&=]*)/g;
    val.replace(reg, function(rs, key, value) {
        value = String(value);
        ret[key] = value;
        return rs;
    });
    return ret;
}


function config(file) {
    const options = { modules: [] };

    if (file) {
        let configFile = path.join(CONTEXT, file);
        defaultsDeep(options, require(configFile));
        CONTEXT = path.resolve(configFile, '../');
    } else {
        try {
            // 尝试加载目录默认的配置文件
            let file = path.join(CONTEXT, CONFIG_PATH_NAME);
            defaultsDeep(options, require(file));
        } catch (e) { }
    }

    defaultsDeep(options, {
        modules: program.modules,
        dependencies: program.dependencies,
        assets: program.assets,
        parallel: program.parallel,
        build: (() => {
            let map = {};
            var reg = /^build[A-Z]/;
            Object.keys(program).forEach((key) => {
                if (reg.test(key)) {
                    map[key] = program[key];
                }
            });
            return map;
        })()
    });

    return options;
}


function init() {
    fs.access(path.join(CONTEXT, CONFIG_PATH_NAME), errors => {
        if (errors) {
            let example = path.join(__dirname, '..', 'example');
            gulp.src([
                path.join(example, 'git-webpack-module-example', '**/*'),
                path.join(example, 'git-webpack.json')
            ]).pipe(gulp.dest('./'));
            console.log(`"${CONFIG_PATH_NAME}" has been created.`);
        }
    });
}


if (program.init) {
    init();
} else {
    gitWebpack(config(program.config), CONTEXT);
}